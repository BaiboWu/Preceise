#include "algorithm.h"

uint16_t ITER_NUM = 100;

float alpha_1[150]={-30.0000000000000, -29.9779396385059, -29.9117390169495, -29.8013399789855, -29.6466471195523, -29.4475300886911, -29.2038268573113, -28.9153479836968, -28.5818819282106, -28.2032014703179, -27.7790712860908, -27.3092567450318, -26.7935339815401, -26.2317012877061, -25.6235918593626, -24.9690879054108, -24.2681361003947, -23.5207643212481, -22.7270995604786, -21.8873868495914, -21.0020089586643, -20.0715065618537, -19.0965984763872, -18.0782014975947, -17.0174492693158, -15.9157095534382, -14.7745992013245, -13.5959960912387, -12.3820472875702, -11.1351727071739, -9.85806365152011, -8.55367568412542, -7.22521550099476, -5.87612165334447, -4.51003922782765, -3.13078885643320, -1.74233069898380, -0.348724296149912, 1.04591458989196, 2.43745886485944, 3.82181534273276, 5.19496893819743, 6.55302447123095, 7.89224487635390, 9.20908480334109, 10.5002188357357, 11.7625638189058, 12.9932950605721, 14.1898564251253, 15.3499645732000, 16.4716077886840, 17.5530399801021, 18.5927705401449, 19.5895507979324, 20.5423578083426, 21.4503761982663, 22.3129787388249, 23.1297062433728, 23.9002473108975, 24.6244183496723, 25.3021442319114, 25.9334398506591, 26.5183927779320, 27.0571471598634, 27.5498889310278, 27.9968323863294, 28.3982081143800, 28.7542522704376, 29.0651971487685, 29.3312630027271, 29.5526510548929, 29.7295376382931, 29.8620694122004, 29.9503596014273, 29.9944852157799, 29.9944852157799, 29.9503596014273, 29.8620694122004, 29.7295376382931, 29.5526510548929, 29.3312630027271, 29.0651971487685, 28.7542522704376, 28.3982081143800, 27.9968323863294, 27.5498889310278, 27.0571471598634, 26.5183927779320, 25.9334398506591, 25.3021442319114, 24.6244183496723, 23.9002473108975, 23.1297062433729, 22.3129787388249, 21.4503761982663, 20.5423578083426, 19.5895507979324, 18.5927705401449, 17.5530399801021, 16.4716077886840, 15.3499645732001, 14.1898564251253, 12.9932950605721, 11.7625638189058, 10.5002188357357, 9.20908480334111, 7.89224487635391, 6.55302447123098, 5.19496893819745, 3.82181534273277, 2.43745886485944, 1.04591458989198, -0.348724296149911, -1.74233069898377, -3.13078885643318, -4.51003922782765, -5.87612165334448, -7.22521550099474, -8.55367568412541, -9.85806365152008, -11.1351727071738, -12.3820472875702, -13.5959960912387, -14.7745992013245, -15.9157095534382, -17.0174492693158, -18.0782014975947, -19.0965984763872, -20.0715065618537, -21.0020089586643, -21.8873868495914, -22.7270995604786, -23.5207643212481, -24.2681361003947, -24.9690879054108, -25.6235918593626, -26.2317012877061, -26.7935339815401, -27.3092567450318, -27.7790712860908, -28.2032014703179, -28.5818819282106, -28.9153479836968, -29.2038268573113, -29.4475300886911, -29.6466471195523, -29.8013399789855, -29.9117390169495, -29.9779396385059, -30.0000000000000};  
float belta_1[150]={0, 1.20778513722787, 2.41395823483008, 3.61690368463490, 4.81499877970698, 6.00661026183295, 7.19009098816361, 8.36377676154877, 9.52598337313873, 10.6750039107468, 11.8091063921600, 12.9265317889035, 14.0254925126969, 15.1041714437216, 16.1607215864878, 17.1932664451104, 18.1999012146276, 19.1786948879816, 20.1276933786729, 21.0449237560793, 21.9283996830993, 22.7761281332491, 23.5861174457747, 24.3563867520426, 25.0849767740152, 25.7699619559345, 26.4094638438703, 27.0016655756037, 27.5448272871624, 28.0373021847019, 28.4775529745240, 28.8641682935928, 29.1958787420202, 29.4715720917139, 29.6903072353737, 29.8513264500726, 29.9540655813184, 29.9981618066854, 29.9834587110316, 29.9100084943905, 29.7780712337996, 29.5881112254509, 29.3407905370097, 29.0369599952834, 28.6776479159693, 28.2640469456103, 27.7974994284287, 27.2794817314652, 26.7115879611928, 26.0955134857164, 25.4330386420944, 24.7260129621425, 23.9763401964115, 23.1859643588386, 22.3568569573187, 21.4910055210110, 20.5904034856936, 19.6570414553118, 18.6928998217772, 17.6999426962288, 16.6801130831080, 15.6353292129493, 14.5674819399658, 13.4784331054467, 12.3700147667769, 11.2440291936788, 10.1022495372655, 8.94642108299616, 7.77826300502494, 6.59947054626602, 5.41171755533757, 4.21665931810577, 3.01593562757635, 1.81117404120378, 0.603993279178619, -0.603993279178625, -1.81117404120377, -3.01593562757634, -4.21665931810577, -5.41171755533756, -6.59947054626602, -7.77826300502493, -8.94642108299615, -10.1022495372655, -11.2440291936788, -12.3700147667769, -13.4784331054467, -14.5674819399658, -15.6353292129493, -16.6801130831080, -17.6999426962288, -18.6928998217772, -19.6570414553118, -20.5904034856936, -21.4910055210110, -22.3568569573187, -23.1859643588386, -23.9763401964115, -24.7260129621425, -25.4330386420944, -26.0955134857164, -26.7115879611928, -27.2794817314652, -27.7974994284287, -28.2640469456103, -28.6776479159693, -29.0369599952834, -29.3407905370097, -29.5881112254509, -29.7780712337996, -29.9100084943905, -29.9834587110316, -29.9981618066854, -29.9540655813184, -29.8513264500726, -29.6903072353737, -29.4715720917139, -29.1958787420202, -28.8641682935928, -28.4775529745240, -28.0373021847019, -27.5448272871624, -27.0016655756037, -26.4094638438703, -25.7699619559345, -25.0849767740152, -24.3563867520426, -23.5861174457748, -22.7761281332491, -21.9283996830993, -21.0449237560793, -20.1276933786729, -19.1786948879816, -18.1999012146276, -17.1932664451104, -16.1607215864879, -15.1041714437216, -14.0254925126969, -12.9265317889035, -11.8091063921600, -10.6750039107468, -9.52598337313875, -8.36377676154875, -7.19009098816362, -6.00661026183294, -4.81499877970699, -3.61690368463491, -2.41395823483008, -1.20778513722786, 0};  

float q_real[3]={0.0}, delta_q[3] = {0.0};
float alpha_targ=0, belta_targ=0, alpha_step = 0, belta_step=0, alpha_real = 0, belta_real=0;
float delta11= 0;

float deg_Node2_0_Last=0, deg_Node2_1_Last=0;

u8 send_flag=0, print_flag=0;
float delta_ang, deg_yuzhi[2]={0.1, 0.1};
float P_ang=0.15;
float deg_kuadu=3, phi_n = -30, angle0_alpha = 0, angle0_belta = 0;

uint32_t kk=0, m_encoder[3] = {0};
uint16_t cur_min[3] = {80, 80, 80};

u8 start_flag=0, count_1=0, speed = 20;//¿ØÖÆÃ¿¼¸¸öÖÜÆÚ×ßÒ»¸öµã
u8 cur_flag[3] = {0, 0, 0}, pos_flag[3] = {1, 1, 1}, zero_flag = 0;
u8 switch_flag = 0, k0 = 0, k = 0, count_tens = 0, ii = 0;

float d_l = 24.7;

void Algorithm(void)//´Ë´¦Èç¸ü¸ÄTIMforTASKÐèÊÖ¶¯¸ü¸Ä
{	
	u8 i, j;
	/*»ñÈ¡µçÎ»¼Æ¶ÁÊý£¬²¢×ª»»³É½Ç¶ÈÖµ*/
	PotPin_Node2_GetValue();
	//PotPin_Node1_GetValue();
	
	{//¶ÔµçÎ»¼Æ¶ÁÊýÏÞ·ù
		if( fabs(deg_Node2[0]-deg_Node2_0_Last) >=deg_kuadu)
			deg_Node2[0]=deg_Node2_0_Last;
		if( fabs(deg_Node2[1]-deg_Node2_1_Last) >=deg_kuadu)
			deg_Node2[1]=deg_Node2_1_Last;		
		
		deg_Node2_0_Last=deg_Node2[0];
		deg_Node2_1_Last=deg_Node2[1];
		
	}
	if(zero_flag == 1)
	{
		zero_flag = 0;
		angle0_alpha = deg_Node2[0];
		angle0_belta = deg_Node2[1];
	}
	
	if(zero_flag == 2)
	{
		i = ii;
		zero_flag = 0;
		pos_flag[i] = 0;
		
		if(cur_flag[i] == 0)
		{
			Switchto_cur(7+i);
			cur_flag[i] = 1;
			delay_ms(1);
		}
		
		//cur[i] = 100;
		
		EPOS_SDOSetTargetCur(7+i, cur_min[i]);
	}
	
	if(zero_flag == 3)
	{
		i = ii;
		zero_flag = 0;
		cur_flag[i] = 0;
		if(pos_flag[i] == 0)
		{
			Switchto_pos(7+i);
			pos_flag[i] = 1;
			delay_ms(1);
		}
		Motor_StartPos(7+i,delta11);
	}
	
	alpha_real = deg_Node2[0] - angle0_alpha;
	belta_real = deg_Node2[1] - angle0_belta;
	
	//ÅÜÔ²¸øÄ¿±êalpha belta
	if(start_flag==1)
	{
		if(count_1==speed)
		{
			count_1=0;
			alpha_targ = alpha_1[kk];
			belta_targ = belta_1[kk];
			
			kk=kk+1;
			if(kk==150) kk=0;
		}
		count_1+=1;
	} 
	
	if(start_flag==2)
	{
		if(count_1==speed)
		{
			count_1=0;
			alpha_targ = 30 * sin(kk/150.0 * 2 * PI);
			
			kk=kk+1;
			if(kk==150) kk=0;
		}
		count_1+=1;
	}
	
	if(start_flag==3)
	{
		if(count_1==speed)
		{
			count_1=0;
			belta_targ = 30 * sin(kk/150.0 * 2 * PI);
			
			kk=kk+1;
			if(kk==150) kk=0;
		}
		count_1+=1;
	}
	
	//¼ÆËãÊµ¼Ê3¸ùÉþ ¿×¼ä¾àÀë
	delta_ang = P_ang * (alpha_targ - alpha_real);
	if(fabs(delta_ang) > 1.0)
		delta_ang = 1.0 * (delta_ang/fabs(delta_ang));
	alpha_step = alpha_real + delta_ang;
	
	delta_ang = P_ang * (belta_targ - belta_real);
	if(fabs(delta_ang) > 1.0)
		delta_ang = 1.0 * (delta_ang/fabs(delta_ang));
	belta_step = belta_real + delta_ang;
		
	for(i = 0; i < 3; i++)
	{
		q_real[i] = q_calc(alpha_real,belta_real, phi_n, i);
		delta_q[i] = q_real[i] - q_calc(alpha_step,belta_step, phi_n, i);
	}
	
	//½Ç¶ÈÅÐ¶Ï=0µÄãÐÖµ£¬ÔÚÎó²îãÐÖµ·¶Î§¼´²»¸øµç»úÇý¶¯Á¿
	if( (fabs(alpha_real-alpha_targ)< deg_yuzhi[0]) && (fabs(belta_real-belta_targ)< deg_yuzhi[1]))
	{
		for(i = 0; i < 3; i++)
		{
			delta_q[i] = 0;
		}
	}
				
	if(send_flag == 1)
	{
		switch_flag = 0;
		k = k0;
		for(j = k+1; j < k+4; j++)
		{
			if(j > 2)
				i = j - 3;
			else
				i = j;
			
			count_tens++;
			if(count_tens >= ITER_NUM)
			{
				count_tens = 0;
				if((delta_q[i] < 0) && (switch_flag == 0))
				{		
					pos_flag[i] = 0;
					if(cur_flag[i] == 0)
					{
						Switchto_cur(7+i);
						
						cur_flag[i] = 1;
						delay_ms(1);
					}
					
					EPOS_SDOSetTargetCur(7+i, cur_min[i]);
					switch_flag = 1;
					k0 = i;
				}
				else
				{
					cur_flag[i] = 0;
					if(pos_flag[i] == 0)
					{
						Switchto_pos(7 + i);
						delay_ms(1);
						pos_flag[i] = 1;
					}
//					delta_q[i] = 0;
//					Motor_StartPos(7+i,delta_q[i]);
				}
			}
			else
			{
				cur_flag[i] = 0;
				if(pos_flag[i] == 0)
				{
					Switchto_pos(7 + i);
					delay_ms(1);
					pos_flag[i] = 1;
				}
				Motor_StartPos(7+i,delta_q[i]);
			}
		}
	}
	
	if(print_flag==1)
	{
		VS4Channal_Send(100*alpha_real,100*belta_real, 100*alpha_targ,100*belta_targ); 
	}

	if(print_flag==2)
	{
		VS4Channal_Send(1000*pos_flag[0],1000*pos_flag[1], 1000*pos_flag[2],0); 
	}
	
}
